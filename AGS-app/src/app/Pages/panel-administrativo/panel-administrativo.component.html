<div class="fade-in-up">
  <!-- TEXTO ENTRADA -->
  <div class="text-center p-4">
    <h1 class="fw-bold text-primary mb-2">
      <i class="bi bi-speedometer2 me-2"></i> Panel Administrativo
    </h1>
    <p class="text-muted fs-5 mb-0">Gestiona los usuarios del sistema</p>
  </div>

  <!-- NAVBAR lista/crear -->
  <nav class="py-3 mb-4">
    <ul class="nav justify-content-center nav-switch">
      <li class="nav-item">
        <a href="#" class="nav-link" [class.active]="showList" (click)="show('lista', $event)">
          <i class="bi bi-list-ul me-2"></i> Lista de Usuarios
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" [class.active]="showCreate" (click)="show('crear', $event)">
          <i class="bi bi-person-plus me-2"></i> Crear Usuario
        </a>
      </li>
    </ul>
  </nav>

  <!-- TABLA DE USUARIOS -->
  <div class="usuarios-wrapper" *ngIf="showList">

    <div class="usuarios-card">

      <div class="d-flex justify-content-between align-items-end mb-3 px-2 border-bottom pb-3">
        <div>
          <h3 class="fw-bold mb-1" style="color: #406AFF; font-size: 1.75rem;">
            Usuarios Registrados
          </h3>
          <p class="text-secondary small mb-0">
            Mostrando: <span class="fw-bold text-dark">{{ estadoActual | titlecase }}s</span>
          </p>
        </div>

        <div class="switch-container p-1 rounded-pill bg-light border d-flex">
          <button class="btn btn-sm rounded-pill px-3 fw-medium transition-btn"
            [class.active-switch]="estadoActual === 'activo'" (click)="getUserByStatus('activo')">
            Activos
          </button>

          <button class="btn btn-sm rounded-pill px-3 fw-medium transition-btn"
            [class.active-switch]="estadoActual === 'inactivo'" (click)="getUserByStatus('inactivo')">
            Inactivos
          </button>
        </div>

      </div>

      <!-- LOADING -->
      <div *ngIf="loading" class="text-center p-5 my-3">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted mb-0 small">Cargando usuario...</p>
      </div>

      <div class="table-responsive" *ngIf="!loading">
        <table class="table align-middle custom-hover-table">
          <thead>
            <tr>
              <th class="ps-4" style="width: 35%;">USUARIO</th>
              <th style="width: 30%;">CONTACTO</th>
              <th style="width: 15%;">ROL</th>
              <th class="text-end pe-4" style="width: 20%;">ACCIONES</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of listaUsuarios">

              <td class="ps-4">
                <div class="d-flex align-items-center">

                  <div class="avatar-outline me-3">
                    <span *ngIf="user.nombre && user.apellido">
                      {{ user.nombre?.charAt(0) }}{{ user.apellido?.charAt(0) }}
                    </span>
                    <span *ngIf="!user.nombre || !user.apellido">
                      <i class="bi bi-person"></i>
                    </span>
                  </div>

                  <div class="d-flex flex-column">
                    <span class="fw-bold text-dark fs-5">{{ user.nombre }} {{ user.apellido }}</span>
                    <span class="text-secondary small fw-medium">ID: #{{ user.id }}</span>
                  </div>
                </div>
              </td>

              <td>
                <div class="d-flex flex-column gap-1">
                  <div class="contact-item">
                    <i class="bi bi-envelope me-2 text-primary"></i>
                    <span>{{ user.mail }}</span>
                  </div>
                  <div class="contact-item">
                    <i class="bi bi-telephone me-2 text-muted"></i>
                    <span>{{ user.telefono }}</span>
                  </div>
                </div>
              </td>

              <td>
                <span class="rol-minimalista">
                  Admin
                </span>
              </td>

              <td class="text-end pe-4">
                <div class="d-flex justify-content-end gap-2">

                  <button class="btn-action-outline btn-view" (click)="getUsersById(user.id)" data-bs-toggle="modal"
                    data-bs-target="#modalDetalles" title="Ver ficha">
                    <i class="bi bi-eye-fill"></i>
                  </button>

                  <ng-container *ngIf="estadoActual === 'activo'">

                    <button class="btn-action-outline btn-edit" (click)="EditValues(user)" data-bs-toggle="modal"
                      data-bs-target="#modalEditar" title="Editar">
                      <i class="bi bi-pencil-fill"></i>
                    </button>

                    <button class="btn-action-outline btn-delete" (click)="getId(user.id)" data-bs-toggle="modal"
                      data-bs-target="#modalEliminar" title="Eliminar">
                      <i class="bi bi-trash-fill"></i>
                    </button>

                  </ng-container>

                </div>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal DETALLES -->
<div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-primary ms-2">Ficha de Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body px-4 pb-4 pt-2">

        <div *ngIf="!detallesUsuario" class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
        </div>

        <div *ngIf="detallesUsuario">
          <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3 mt-3">
            <div class="bg-white p-3 rounded-circle shadow-sm me-3 text-primary">
              <i class="bi bi-person-circle fs-1"></i>
            </div>
            <div>
              <h4 class="mb-0 fw-bold text-dark">{{ detallesUsuario.nombre }} {{ detallesUsuario.apellido }}</h4>
              <span class="badge rounded-pill"
                [ngClass]="detallesUsuario.estaEliminado ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success'">
                {{ detallesUsuario.estaEliminado ? 'Eliminado' : 'Activo' }}
              </span>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-6">
              <label class="text-muted small fw-bold text-uppercase">Fecha Alta</label>
              <p class="mb-0 fw-medium text-dark">{{ detallesUsuario.fechaAlta || '-' }}</p>
            </div>
            <div class="col-6">
              <label class="text-muted small fw-bold text-uppercase">Creado Por</label>
              <p class="mb-0 fw-medium text-dark">Admin ID: {{ detallesUsuario.creadoPor || '-' }}</p>
            </div>

            <div class="col-12" *ngIf="detallesUsuario.estaEliminado">
              <hr class="text-muted opacity-25">
            </div>

            <div class="col-6" *ngIf="detallesUsuario.estaEliminado">
              <label class="text-muted small fw-bold text-uppercase">Fecha Baja</label>
              <p class="mb-0 fw-medium text-danger">{{ detallesUsuario.fechaBaja }}</p>
            </div>
            <div class="col-6" *ngIf="detallesUsuario.estaEliminado">
              <label class="text-muted small fw-bold text-uppercase">Eliminado Por</label>
              <p class="mb-0 fw-medium text-dark">{{ detallesUsuario.eliminadoPor }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
        <button type="button" class="btn btn-light rounded-pill px-4 w-100" data-bs-dismiss="modal">Cerrar
          Ficha</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal EDITAR -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">

      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-primary ms-2">Editar Datos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body px-4 pt-4">
        <form #editForm="ngForm">

          <div class="row g-3 mb-3">

            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label text-muted small text-uppercase fw-bold">Nombre</label>
                <small class="text-muted">{{ nombreEdit?.length || 0 }} / 50</small>
              </div>
              <input type="text" class="form-control bg-light border-0" [(ngModel)]="nombreEdit" name="nombreEdit"
                maxlength="50" required />
            </div>

            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label text-muted small text-uppercase fw-bold">Apellido</label>
                <small class="text-muted">{{ apellidoEdit?.length || 0 }} / 50</small>
              </div>
              <input type="text" class="form-control bg-light border-0" [(ngModel)]="apellidoEdit" name="apellidoEdit"
                maxlength="50" required />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label text-muted small text-uppercase fw-bold">Email</label>
            <input type="email" class="form-control bg-light border-0" [(ngModel)]="mailEdit" name="mailEdit"
              pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" required />
            <div
              *ngIf="editForm.controls['mailEdit']?.invalid && (editForm.controls['mailEdit']?.dirty || editForm.controls['mailEdit']?.touched)"
              class="text-danger small mt-1">
              Formato de email inválido
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label text-muted small text-uppercase fw-bold">Teléfono</label>
              <small class="text-muted" [ngClass]="{'text-danger': telefonoEdit?.length !== 10}">
                {{ telefonoEdit?.length || 0 }} / 10
              </small>
            </div>

            <input type="tel" class="form-control bg-light border-0" [(ngModel)]="telefonoEdit" name="telefonoEdit"
              maxlength="10" placeholder="Solo números" pattern="^[0-9]{10}$" required />
            <div
              *ngIf="editForm.controls['telefonoEdit']?.invalid && (editForm.controls['telefonoEdit']?.dirty || editForm.controls['telefonoEdit']?.touched)"
              class="text-danger small mt-1">
              El teléfono debe tener 10 números y sin letras.
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer border-top-0 pt-0 pb-4 px-4">
        <button id="btnCerrarEditar" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary rounded-pill px-4 shadow-sm" (click)="editarUser()"
          [disabled]="editForm.invalid">
          Guardar Cambios
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal ELIMINAR -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden px-3">

      <div class="modal-header border-0 pb-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body text-center pt-0">
        <div class="mx-auto mb-4 d-flex align-items-center justify-content-center bg-danger-subtle rounded-circle"
          style="width: 80px; height: 80px;">
          <i class="bi bi-person-x text-danger" style="font-size: 2.5rem;"></i>
        </div>

        <h4 class="fw-bold mb-3 text-dark">¿Eliminar Usuario?</h4>
        <p class="text-muted mb-4 px-2">
          Esta acción quitará el acceso al sistema para este usuario. ¿Deseas continuar?
        </p>

        <div class="d-flex justify-content-center gap-3 mt-3 mb-3">
          <button id="btnCerrarEliminar" type="button"
            class="btn btn-light text-muted px-4 fw-medium rounded-pill border-0" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="button" class="btn btn-danger px-4 fw-bold rounded-pill shadow-sm" (click)="deleteUser()">
            Eliminar
          </button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Formulario CREAR -->
<section class="py-5 bg-light container shadow-lg rounded-4" *ngIf="showCreate" style="max-width: 800px;">

  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">Agregar Nuevo Usuario</h2>
    <p class="text-muted">Completa los datos para dar de alta un acceso.</p>
  </div>

  <form (ngSubmit)="createUser()" #formUsuario="ngForm" class="mx-auto" style="max-width: 700px;">

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <div class="d-flex justify-content-between">
          <label class="form-label text-muted small text-uppercase fw-bold">Nombre *</label>
          <small class="text-muted">{{ nombre?.length || 0 }}/50</small>
        </div>
        <input type="text" class="form-control" placeholder="Ej: Juan" name="nombre" [(ngModel)]="nombre" maxlength="50"
          required>
      </div>

      <div class="col-md-6">
        <div class="d-flex justify-content-between">
          <label class="form-label text-muted small text-uppercase fw-bold">Apellido *</label>
          <small class="text-muted">{{ apellido?.length || 0 }}/50</small>
        </div>
        <input type="text" class="form-control" placeholder="Ej: Pérez" name="apellido" [(ngModel)]="apellido"
          maxlength="50" required>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label text-muted small text-uppercase fw-bold">Email Corporativo *</label>
      <input type="email" class="form-control" placeholder="juan.perez@empresa.com" name="mail" [(ngModel)]="mail"
        required>
      <div
        *ngIf="formUsuario.controls['mail']?.invalid && (formUsuario.controls['mail']?.dirty || formUsuario.controls['mail']?.touched)"
        class="text-danger small mt-1">
        Formato de email inválido
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="d-flex justify-content-between">
          <label class="form-label text-muted small text-uppercase fw-bold">Teléfono *</label>
          <small class="text-muted">{{ telefono?.length || 0 }}/10</small>
        </div>
        <input type="text" class="form-control" placeholder="Ej: 1112345678" name="telefono" [(ngModel)]="telefono"
          maxlength="10" required>
      </div>

      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-label text-muted small text-uppercase fw-bold">Contraseña *</label>
          <small class="text-muted" [class.text-danger]="(contrasena?.length || 0) < 8"
            [class.text-success]="(contrasena?.length || 0) >= 8">
            Mín. 8 caracteres
          </small>
        </div>
        <input type="password" class="form-control" placeholder="******" name="contrasena" [(ngModel)]="contrasena"
          required minlength="8">
      </div>
    </div>

    <div class="text-center mt-4 border-top pt-3">
      <button type="submit" class="btn btn-primary btn-lg px-5" [disabled]="formUsuario.invalid">
        Confirmar usuario
      </button>
    </div>

  </form>

  <div *ngIf="mensajeError" class="alert alert-danger text-center mt-4 mx-auto" style="max-width: 600px;">
    <i class="bi bi-exclamation-circle-fill me-2"></i> {{ textoError }}
  </div>

</section>

<!-- MENSAJE EXITO -->
<div class="cartel-flotante position-fixed start-50 translate-middle-x" [class.mostrar]="mensajeExito">
  <div class="alert alert-success d-flex align-items-center shadow-lg border-0 rounded-pill px-4 py-3" role="alert">
    <i class="bi bi-check-circle-fill fs-4 me-3 flex-shrink-0"></i>
    <div class="text-truncate-multiline">
      <span class="fw-bold">¡Excelente!</span> {{ textoMensaje }}
    </div>
  </div>
</div>